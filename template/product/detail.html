{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - Detail{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/toggle.css' %}">
    <div class="minimal-centered-wrapper">
        {% if user.is_authenticated %} {# ÁôªÈôÜÁöÑËØù #}
            <div class="minimal-photo-detail-container">
                <!-- Â∑¶‰æßÔºöÂõæÁâáÂ±ïÁ§∫ -->
                <div class="minimal-photo-image-container">
                    <img src="{{ product.image.url|default:'https://s2.loli.net/2024/12/02/SBkMjwRoA7sba6c.jpg' }}"
                         alt="{{ product.name }}"
                         class="minimal-photo-image">
                </div>

                <!-- Âè≥‰æßÔºö‰ø°ÊÅØÂíåÊèèËø∞ -->
                <div class="minimal-photo-info-container">
                    <!-- ‰∏äÂçäÈÉ®ÂàÜÔºö‰ø°ÊÅØ -->
                    <div class="minimal-photo-meta-panel">
                        <h1 class="minimal-photo-title">{{ product.name }}</h1>

                        <div class="minimal-photo-specs">
                            <div class="minimal-spec-item">
                                <span class="minimal-spec-icon">üìÖ</span>
                                <span class="minimal-spec-value">{{ product.Shooting_Date|date:"Y.m.d" }}</span>
                            </div>
                            <div class="minimal-spec-item">
                                <span class="minimal-spec-icon">üÜî</span>
                                <span class="minimal-spec-value">No. {{ product.id }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºöÊèèËø∞ -->
                    <!-- Âú®ÊèèËø∞Âå∫ÂüüÊ∑ªÂä†ÂÜÖÂÆπÈïøÂ∫¶Ê£ÄÊµãÊ†áËÆ∞ -->
                    <div class="minimal-description-content" data-content-length="{{ product.description|length }}">
                        {{ product.description|safe }}
                    </div>

                    <div class="minimal-visibility-control">
                        <span class="minimal-visibility-label">Visibility:</span>
                        <label class="minimal-switch">
                            <input type="checkbox"
                                   id="visibilityToggle"
                                   {% if product.visible %}checked{% endif %}
                                   data-product-id="{{ product.id }}"
                                   data-url="{% url 'toggle_visibility' product.id %}">
                            <span class="minimal-slider"></span>
                        </label>
                        <span class="minimal-visibility-status">
            {% if product.visible %}Public{% else %}Private{% endif %}
        </span>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈíÆ -->
                    <div class="minimal-photo-actions">
                        <a href="{% url 'products-list' %}" class="minimal-back-btn">Back to Gallery</a>
                        <a href="{% url 'product_delete' product.id %}" class="minimal-delete-btn">Delete Photo</a>
                    </div>
                </div>
            </div>
            {# ------------------------------------------------------------------------------------------- #}
        {% else %}   {# Ê≤°ÁôªÈôÜÁöÑËØù #}
            <div class="minimal-photo-detail-container">
                <!-- Â∑¶‰æßÔºöÂõæÁâáÂ±ïÁ§∫ -->
                <div class="minimal-photo-image-container">
                    <img src="{{ product.image.url|default:'https://s2.loli.net/2024/12/02/SBkMjwRoA7sba6c.jpg' }}"
                         alt="{{ product.name }}"
                         class="minimal-photo-image">
                </div>

                <!-- Âè≥‰æßÔºö‰ø°ÊÅØÂíåÊèèËø∞ -->
                <div class="minimal-photo-info-container">
                    <!-- ‰∏äÂçäÈÉ®ÂàÜÔºö‰ø°ÊÅØ -->
                    <div class="minimal-photo-meta-panel">
                        <h1 class="minimal-photo-title">{{ product.name }}</h1>

                        <div class="minimal-photo-specs">
                            <div class="minimal-spec-item">
                                <span class="minimal-spec-icon">üìÖ</span>
                                <span class="minimal-spec-value">{{ product.Shooting_Date|date:"Y.m.d" }}</span>
                            </div>
                            <div class="minimal-spec-item">
                                <span class="minimal-spec-icon">üÜî</span>
                                <span class="minimal-spec-value">No. {{ product.id }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="minimal-description-content" data-content-length="{{ product.description|length }}">
                        {{ product.description|safe }}
                    </div>

                    <div class="minimal-photo-actions">
                        <a href="{% url 'products-list' %}" class="minimal-back-btn">Back to Gallery</a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>


    <script>
        // Ê†πÊçÆÂÜÖÂÆπÈïøÂ∫¶Âä®ÊÄÅË∞ÉÊï¥Ê†∑Âºè
        document.addEventListener('DOMContentLoaded', function () {
            const descContent = document.querySelector('.minimal-description-content');
            if (descContent) {
                const length = descContent.getAttribute('data-content-length') || 0;
                if (length > 500) {
                    descContent.parentElement.classList.add('long-description');
                }
            }
        });


    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get the delete button
            const deleteBtn = document.querySelector('.minimal-delete-btn');

            // Add click event listener
            deleteBtn.addEventListener('click', function (e) {
                // Prevent immediate navigation
                e.preventDefault();

                // Get the photo name from the title
                const photoName = document.querySelector('.minimal-photo-title').textContent;
                const deleteUrl = this.href;

                // Create custom confirmation dialog
                const dialog = document.createElement('div');
                dialog.className = 'minimal-confirm-dialog';
                dialog.innerHTML = `
            <div class="minimal-dialog-content">
                <h4>Confirm Deletion</h4>
                <p>Are you sure you want to delete "${photoName}"?</p>
                <div class="minimal-dialog-actions">
                    <button class="minimal-dialog-cancel">Cancel</button>
                    <button class="minimal-dialog-confirm">Delete</button>
                </div>
            </div>
        `;

                // Style the dialog (could also be in CSS file)
                dialog.style.position = 'fixed';
                dialog.style.top = '0';
                dialog.style.left = '0';
                dialog.style.width = '100%';
                dialog.style.height = '100%';
                dialog.style.backgroundColor = 'rgba(0,0,0,0.5)';
                dialog.style.display = 'flex';
                dialog.style.justifyContent = 'center';
                dialog.style.alignItems = 'center';
                dialog.style.zIndex = '1000';

                // Style dialog content
                const content = dialog.querySelector('.minimal-dialog-content');
                content.style.backgroundColor = 'white';
                content.style.padding = '2rem';
                content.style.borderRadius = '4px';
                content.style.maxWidth = '400px';
                content.style.width = '90%';

                // Add to document
                document.body.appendChild(dialog);

                // Handle cancel button
                dialog.querySelector('.minimal-dialog-cancel').addEventListener('click', function () {
                    document.body.removeChild(dialog);
                });

                // Handle confirm button
                dialog.querySelector('.minimal-dialog-confirm').addEventListener('click', function () {
                    window.location.href = deleteUrl;
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggle = document.getElementById('visibilityToggle');

            if (toggle) {
                toggle.addEventListener('change', function () {
                    const productId = this.dataset.productId;
                    const url = this.dataset.url;
                    const isVisible = this.checked;
                    const statusText = isVisible ? 'Public' : 'Private';

                    // Á´ãÂç≥Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                    document.querySelector('.minimal-visibility-status').textContent = statusText;

                    // ÂèëÈÄÅAJAXËØ∑Ê±Ç
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            visible: isVisible
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                // Â¶ÇÊûúÂ§±Ë¥•ÔºåÊÅ¢Â§çÂéüÂßãÁä∂ÊÄÅ
                                toggle.checked = !isVisible;
                                document.querySelector('.minimal-visibility-status').textContent =
                                    isVisible ? 'Private' : 'Public';
                            }
                        });
                });
            }
        });
    </script>
{% endblock %}